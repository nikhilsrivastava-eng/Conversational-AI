<!DOCTYPE html>
<html>
<head>
    <title>Healthcare Chatbot</title>
</head>
<body>
    <h1>Healthcare Chatbot</h1>
    <button id="recordButton">Record</button>
    <p id="status"></p>
    <p id="transcription"></p>
    <p id="response"></p>

    <script>
        const recordButton = document.getElementById('recordButton');
        const status = document.getElementById('status');
        const transcription = document.getElementById('transcription');
        const response = document.getElementById('response');

        let mediaRecorder;
        let chunks = [];

        recordButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordButton.textContent = 'Record';
                status.textContent = 'Recording stopped.';
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        recordButton.textContent = 'Stop';
                        status.textContent = 'Recording...';

                        mediaRecorder.ondataavailable = e => {
                            chunks.push(e.data);
                        };

                        mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { 'type' : 'audio/wav' });
                            chunks = [];
                            sendAudioToServer(blob);
                        };
                    });
            }
        });

        function sendAudioToServer(blob) {
            const formData = new FormData();
            formData.append('file', blob);

            fetch('/api/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                transcription.textContent = `Transcription: ${data.transcription}`;
                return fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: data.transcription })
                });
            })
            .then(response => response.json())
            .then(data => {
                response.textContent = `Response: ${data.response}`;
                return fetch('/api/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: data.response })
                });
            })
            .then(response => response.blob())
            .then(blob => {
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            })
            .catch(error => {
                console.error('Error:', error);
                status.textContent = 'Error occurred.';
            });
        }
    </script>
</body>
</html>
